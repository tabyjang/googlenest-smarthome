---
phase: 02-error-handling
type: execute
---

<objective>
로딩 상태 통합 및 API 에러 처리 개선

목적: 일관된 로딩 UI 제공, API 호출 실패 시 사용자 친화적 에러 메시지 표시
결과물: 공통 LoadingSpinner 컴포넌트, VoiceExperience/Estimator 에러 처리 개선
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-error-handling/02-01-SUMMARY.md
@components/VoiceExperience.tsx
@components/estimator/Estimator.tsx
@components/estimator/EstimatorForm.tsx
@.planning/codebase/CONVENTIONS.md

**Plan 02-01 완료:**
- ErrorBoundary 및 ErrorFallback 구현
- 앱 전체 에러 보호 메커니즘 작동

**현재 API 에러 처리 상태:**
- VoiceExperience: try-catch로 에러 잡지만 console.error만 찍고 fallback 응답 표시
- Estimator: API 호출 실패 시 에러 피드백 없음
- 사용자에게 "무엇이 잘못되었는지" 명확하지 않음

**디자인 시스템:**
- Tailwind 커스텀 컬러: cream, charcoal, gold
- 컴포넌트 스타일: rounded-3xl, shadow-luxury, backdrop-blur
</context>

<tasks>

<task type="auto">
  <name>Task 1: LoadingSpinner 공통 컴포넌트 생성</name>
  <files>components/LoadingSpinner.tsx</files>
  <action>재사용 가능한 로딩 스피너 컴포넌트 생성:

1. Props 인터페이스:
   ```tsx
   interface LoadingSpinnerProps {
     size?: 'sm' | 'md' | 'lg';  // 크기 옵션
     text?: string;               // 표시할 텍스트 (선택)
     fullScreen?: boolean;        // 전체 화면 모드 (선택)
   }
   ```

2. 크기별 스타일:
   - sm: w-6 h-6, border-2
   - md: w-10 h-10, border-2 (기본값)
   - lg: w-16 h-16, border-3

3. 스피너 디자인:
   - 회전하는 원 (border-gold-400 border-t-transparent)
   - animate-spin 적용
   - 중앙 정렬

4. fullScreen 모드:
   - true일 때: min-h-screen flex items-center justify-center bg-cream-100
   - false일 때: inline-flex items-center gap-3

5. 텍스트 스타일:
   - text-charcoal-400 font-light tracking-wide
   - 스피너 옆에 표시

**기존 PageLoader 유지:**
- App.tsx의 PageLoader는 그대로 두기 (Suspense 전용)
- LoadingSpinner는 개별 컴포넌트에서 사용

**주의사항:**
- 디폴트 props 설정 (size: 'md', fullScreen: false)
- 접근성: aria-label="로딩 중" 추가
</action>
  <verify>LoadingSpinner 렌더링 확인, 세 가지 size 모두 정상 표시</verify>
  <done>LoadingSpinner.tsx 생성, size/text/fullScreen props 작동, export default 완료</done>
</task>

<task type="auto">
  <name>Task 2: VoiceExperience 에러 처리 개선</name>
  <files>components/VoiceExperience.tsx</files>
  <action>VoiceExperience 컴포넌트의 API 에러 처리를 사용자 친화적으로 개선:

1. 새로운 state 추가:
   ```tsx
   const [error, setError] = useState<string | null>(null);
   ```

2. try-catch 블록 수정 (46-54번 줄):
   ```tsx
   } catch (e) {
     console.error("AI Error:", e);
     setError("음성 인식 서비스에 일시적인 문제가 발생했습니다. 잠시 후 다시 시도해주세요.");
     setLastResponse(""); // fallback 응답 제거
     setStatus("오류 발생");
   } finally {
     setIsProcessing(false);
     // 에러 메시지는 4초 후 자동 사라짐
     setTimeout(() => {
       setError(null);
       setStatus("음성 버튼을 눌러 시작하세요");
     }, 4000);
   }
   ```

3. UI에 에러 메시지 표시 추가:
   - lastResponse 표시 영역 근처에 에러 메시지 조건부 렌더링
   - 에러 시 빨간 배경 카드:
     ```tsx
     {error && (
       <motion.div
         initial={{ opacity: 0, y: -10 }}
         animate={{ opacity: 1, y: 0 }}
         className="mt-4 p-4 bg-red-50 border border-red-200 rounded-2xl"
       >
         <p className="text-red-600 text-sm">{error}</p>
       </motion.div>
     )}
     ```

4. LoadingSpinner 통합:
   - LoadingSpinner import
   - isProcessing일 때 LoadingSpinner 표시 (기존 "응답 생성 중..." 대체 가능)

**주의사항:**
- 기존 기능 유지 (음성 명령 버튼, 애니메이션 등)
- 에러와 성공 응답 동시에 표시되지 않도록
- console.error는 유지 (디버깅용)
</action>
  <verify>API 실패 시 에러 메시지 표시 확인, 4초 후 자동 사라짐 확인</verify>
  <done>VoiceExperience.tsx 수정 완료, 에러 state 추가, 사용자 친화적 에러 UI 표시</done>
</task>

<task type="auto">
  <name>Task 3: Estimator 에러 처리 추가 및 테스트</name>
  <files>components/estimator/Estimator.tsx, components/estimator/Estimator.test.tsx</files>
  <action>1. Estimator.tsx 에러 처리 추가:

현재 handleQuoteSubmit 함수 (62-85번 줄 추정) 수정:

   a. error state 추가:
   ```tsx
   const [error, setError] = useState<string | null>(null);
   ```

   b. try-catch로 API 호출 감싸기:
   ```tsx
   try {
     setError(null);
     setIsSubmitting(true);

     const response = await fetch('/api/send-quote', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify(payload)
     });

     if (!response.ok) {
       throw new Error(`서버 오류: ${response.status}`);
     }

     const data = await response.json();

     if (!data.success) {
       throw new Error(data.message || '견적 전송에 실패했습니다');
     }

     setSubmitted(true);
   } catch (e) {
     console.error('Quote submission error:', e);
     setError(
       '견적 요청 전송 중 오류가 발생했습니다. 네트워크 연결을 확인하고 다시 시도해주세요.'
     );
   } finally {
     setIsSubmitting(false);
   }
   ```

   c. 에러 메시지 UI 추가:
   - EstimatorForm 위에 에러 메시지 표시 영역 추가
   - 빨간 배경 카드로 에러 표시
   - "다시 시도" 버튼 제공 (setError(null)로 에러 초기화)

2. Estimator 테스트 작성 (components/estimator/Estimator.test.tsx):
   - 테스트 1: 정상 제출 시 성공 메시지 표시
   - 테스트 2: API 실패 시 에러 메시지 표시
   - fetch mock 사용 (global.fetch)
   - React Testing Library + @testing-library/user-event

**주의사항:**
- 기존 submitted 상태와 성공 UI 유지
- 에러 발생 시에도 폼은 열려있어야 함 (사용자가 수정 후 재시도 가능)
- LoadingSpinner 사용 (isSubmitting일 때)
</action>
  <verify>npm test 통과, API 실패 시 에러 메시지 표시, "다시 시도" 버튼 작동</verify>
  <done>Estimator.tsx 에러 처리 추가, Estimator.test.tsx 2개 테스트 통과</done>
</task>

</tasks>

<verification>
완료 전 확인사항:
- [ ] npm test 모든 테스트 통과 (기존 + 신규)
- [ ] npm run build 성공
- [ ] LoadingSpinner 3가지 size 정상 작동
- [ ] VoiceExperience API 실패 시 에러 메시지 표시
- [ ] Estimator API 실패 시 에러 메시지 및 재시도 버튼 작동
- [ ] 에러 메시지가 사용자 친화적 (기술 용어 없음)
</verification>

<success_criteria>

- LoadingSpinner 공통 컴포넌트 생성
- VoiceExperience 에러 처리 개선 (사용자 친화적 메시지)
- Estimator 에러 처리 추가 (try-catch, 재시도 버튼)
- Estimator 테스트 2개 추가 및 통과
- 모든 빌드 및 테스트 통과
- Phase 2 완료: Error Handling 구축 완료
  </success_criteria>

<output>
완료 후 `.planning/phases/02-error-handling/02-02-SUMMARY.md` 생성:

# Phase 2 Plan 2: 로딩 및 API 에러 처리 요약

**일관된 로딩 UI와 사용자 친화적 에러 메시지 구현**

## 달성 사항

- LoadingSpinner 공통 컴포넌트 생성 (size/text/fullScreen props)
- VoiceExperience 에러 처리 개선 (명확한 에러 메시지)
- Estimator 에러 처리 추가 (재시도 기능 포함)
- Estimator 테스트 추가 (정상/에러 케이스)

## 생성/수정 파일

- `components/LoadingSpinner.tsx` - 생성
- `components/VoiceExperience.tsx` - 에러 처리 개선
- `components/estimator/Estimator.tsx` - 에러 처리 추가
- `components/estimator/Estimator.test.tsx` - 생성

## 결정 사항

- LoadingSpinner 크기: sm/md/lg 3단계
- 에러 메시지 전략: 기술 용어 배제, 명확한 액션 제공
- 에러 자동 해제: 4초 후 (VoiceExperience)
- 재시도 방식: 수동 버튼 클릭 (Estimator)

## 발생한 이슈

[이슈가 있었다면 기록, 없으면 "없음"]

## Phase 2 완료

**Error Handling 완료!**

다음: Phase 3 - Performance Optimization
- Three.js 렌더링 최적화
- 번들 크기 감소
- 이미지 최적화
- Lighthouse 90+ 목표

주의: 사용자가 언급한 "히어로 섹션 3D가 너무 무거움" 이슈를 Phase 3에서 해결
</output>
